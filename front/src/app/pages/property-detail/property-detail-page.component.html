@if (loading()) {
  <section class="panel p-5 text-sm text-slate-700" role="status" aria-live="polite">
    Chargement du bien...
  </section>
} @else if (error()) {
  <section class="panel border border-red-200 bg-red-50 p-5 text-sm text-red-700" role="alert">
    {{ error() }}
  </section>
} @else {
  @if (property(); as property) {
    <section class="space-y-4" aria-labelledby="property-detail-title">
      <header class="panel p-5">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-600">Fiche bien</p>
            <h2
              id="property-detail-title"
              class="mt-2 text-3xl font-semibold tracking-tight text-slate-900"
            >
              {{ property.title }}
            </h2>
            <p class="mt-1 text-sm text-slate-500">
              {{ property.address || 'Adresse non renseignée' }}, {{ property.postalCode }}
              {{ property.city }}
            </p>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button
              type="button"
              class="rounded-xl bg-indigo-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              (click)="openVocalModal()"
            >
              Créer un vocal
            </button>

            <a
              routerLink="/app/kanban"
              class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
            >
              Retour pipeline
            </a>

            <button
              type="button"
              class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white"
              disabled
            >
              {{ statusLabels[property.status] }}
            </button>

            @if (previousStatus(); as previousStatus) {
              <button
                type="button"
                class="rounded-xl bg-orange-500 px-3 py-2 text-sm font-semibold text-white transition hover:bg-orange-600"
                [disabled]="statusPending()"
                (click)="goToPreviousStatus()"
              >
                {{ statusLabels[previousStatus] }}
              </button>
            }

            @if (nextStatus(); as nextStatus) {
              <button
                type="button"
                class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700"
                [disabled]="statusPending()"
                (click)="goToNextStatus()"
              >
                {{ statusLabels[nextStatus] }}
              </button>
            }

            @if (property.status !== 'ARCHIVE') {
              <button
                type="button"
                class="rounded-xl bg-slate-500 px-3 py-2 text-sm font-semibold text-white transition hover:bg-slate-600"
                [disabled]="statusPending()"
                (click)="archiveProperty()"
              >
                Archiver
              </button>
            }
          </div>
        </div>

        @if (requestFeedback()) {
          <p
            class="mt-4 rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
            role="status"
            aria-live="polite"
          >
            {{ requestFeedback() }}
          </p>
        }
      </header>

      <nav
        class="panel flex flex-wrap items-center gap-2 p-3"
        aria-label="Sections du dossier bien"
      >
        <button
          type="button"
          class="rounded-xl px-3 py-2 text-sm font-semibold"
          [class.bg-blue-600]="isMainTabActive('property')"
          [class.text-white]="isMainTabActive('property')"
          [class.bg-slate-100]="!isMainTabActive('property')"
          [class.text-slate-700]="!isMainTabActive('property')"
          [attr.aria-pressed]="isMainTabActive('property') ? 'true' : 'false'"
          (click)="setMainTab('property')"
        >
          Donnees du bien
        </button>

        <button
          type="button"
          class="rounded-xl px-3 py-2 text-sm font-semibold"
          [class.bg-blue-600]="isMainTabActive('documents')"
          [class.text-white]="isMainTabActive('documents')"
          [class.bg-slate-100]="!isMainTabActive('documents')"
          [class.text-slate-700]="!isMainTabActive('documents')"
          [attr.aria-pressed]="isMainTabActive('documents') ? 'true' : 'false'"
          (click)="setMainTab('documents')"
        >
          Documents
        </button>

        <button
          type="button"
          class="rounded-xl px-3 py-2 text-sm font-semibold"
          [class.bg-blue-600]="isMainTabActive('prospects')"
          [class.text-white]="isMainTabActive('prospects')"
          [class.bg-slate-100]="!isMainTabActive('prospects')"
          [class.text-slate-700]="!isMainTabActive('prospects')"
          [attr.aria-pressed]="isMainTabActive('prospects') ? 'true' : 'false'"
          (click)="setMainTab('prospects')"
        >
          Prospects
        </button>

        <button
          type="button"
          class="rounded-xl px-3 py-2 text-sm font-semibold"
          [class.bg-blue-600]="isMainTabActive('visits')"
          [class.text-white]="isMainTabActive('visits')"
          [class.bg-slate-100]="!isMainTabActive('visits')"
          [class.text-slate-700]="!isMainTabActive('visits')"
          [attr.aria-pressed]="isMainTabActive('visits') ? 'true' : 'false'"
          (click)="setMainTab('visits')"
        >
          Visites
        </button>

        <button
          type="button"
          class="rounded-xl px-3 py-2 text-sm font-semibold"
          [class.bg-blue-600]="isMainTabActive('messages')"
          [class.text-white]="isMainTabActive('messages')"
          [class.bg-slate-100]="!isMainTabActive('messages')"
          [class.text-slate-700]="!isMainTabActive('messages')"
          [attr.aria-pressed]="isMainTabActive('messages') ? 'true' : 'false'"
          (click)="setMainTab('messages')"
        >
          Messages
        </button>

        <button
          type="button"
          class="rounded-xl px-3 py-2 text-sm font-semibold"
          [class.bg-blue-600]="isMainTabActive('valuation')"
          [class.text-white]="isMainTabActive('valuation')"
          [class.bg-slate-100]="!isMainTabActive('valuation')"
          [class.text-slate-700]="!isMainTabActive('valuation')"
          [attr.aria-pressed]="isMainTabActive('valuation') ? 'true' : 'false'"
          (click)="setMainTab('valuation')"
        >
          Valorisation
        </button>
      </nav>

      @if (isMainTabActive('property')) {
        <section class="panel space-y-4 p-5">
          <div class="flex items-center gap-2 overflow-x-auto pb-1">
            @for (category of propertyCategories; track category.id) {
              <button
                type="button"
                class="whitespace-nowrap rounded-xl px-3 py-2 text-sm font-semibold"
                [class.bg-blue-600]="isActivePropertyCategory(category.id)"
                [class.text-white]="isActivePropertyCategory(category.id)"
                [class.bg-slate-100]="!isActivePropertyCategory(category.id)"
                [class.text-slate-700]="!isActivePropertyCategory(category.id)"
                (click)="setActivePropertyCategory(category.id)"
              >
                {{ category.label }}
              </button>
            }
          </div>

          @if (activePropertyCategoryDefinition(); as category) {
            <div
              class="flex flex-wrap items-center justify-between gap-2 border-t border-slate-200 pt-4"
            >
              <h3 class="text-xl font-semibold text-slate-900">{{ category.label }}</h3>

              <div class="flex items-center gap-2">
                @if (!isEditingActiveCategory()) {
                  <button
                    type="button"
                    class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                    (click)="startEditingActiveCategory()"
                  >
                    Modifier
                  </button>
                } @else {
                  <button
                    type="button"
                    class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                    [disabled]="patchPending()"
                    (click)="cancelEditingActiveCategory()"
                  >
                    Annuler
                  </button>

                  <button
                    type="button"
                    class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700"
                    [disabled]="patchPending()"
                    (click)="saveActivePropertyCategory()"
                  >
                    {{ patchPending() ? 'Enregistrement...' : 'Enregistrer' }}
                  </button>
                }
              </div>
            </div>

            @if (activePropertyForm(); as form) {
              <form class="grid gap-3 sm:grid-cols-2" [formGroup]="form" novalidate>
                @for (field of category.fields; track field.key) {
                  @if (isEditingActiveCategory() || hasFieldValue(category.id, field)) {
                    <article
                      [class]="
                        field.type === 'textarea'
                          ? 'rounded-xl border border-slate-200 bg-slate-50 p-3 sm:col-span-2'
                          : 'rounded-xl border border-slate-200 bg-slate-50 p-3'
                      "
                    >
                      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">
                        {{ field.label }}
                      </p>

                      @if (isEditingActiveCategory()) {
                        @switch (field.type) {
                          @case ('textarea') {
                            <textarea
                              class="field-input mt-2 min-h-24"
                              [formControlName]="field.key"
                            ></textarea>
                          }
                          @case ('select') {
                            <select class="field-input mt-2" [formControlName]="field.key">
                              <option value="">Non renseigné</option>
                              @for (option of field.options ?? []; track option.value) {
                                <option [value]="option.value">{{ option.label }}</option>
                              }
                            </select>
                          }
                          @case ('date') {
                            <input
                              class="field-input mt-2"
                              type="date"
                              [formControlName]="field.key"
                            />
                          }
                          @default {
                            <input
                              class="field-input mt-2"
                              type="text"
                              [formControlName]="field.key"
                            />
                          }
                        }
                      } @else {
                        <p class="mt-2 text-sm text-slate-900">
                          {{ fieldDisplayValue(category.id, field) }}
                        </p>
                      }
                    </article>
                  }
                }
              </form>
            }
          }
        </section>
      }

      @if (isMainTabActive('documents')) {
        <section class="panel space-y-4 p-5">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <h3 class="text-xl font-semibold text-slate-900">Documents par catégorie</h3>
            <button
              type="button"
              class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
              (click)="openUploadModal()"
            >
              Ajouter un document
            </button>
          </div>

          <div class="flex items-center gap-2 overflow-x-auto pb-1">
            @for (tab of visibleDocumentTabs(); track tab.id) {
              <button
                type="button"
                class="whitespace-nowrap rounded-xl px-3 py-2 text-sm font-semibold"
                [class.bg-blue-600]="isActiveDocumentTab(tab.id)"
                [class.text-white]="isActiveDocumentTab(tab.id)"
                [class.bg-slate-100]="!isActiveDocumentTab(tab.id)"
                [class.text-slate-700]="!isActiveDocumentTab(tab.id)"
                (click)="setActiveDocumentTab(tab.id)"
              >
                {{ tab.label }} ({{ documentTabProgressLabel(tab) }})
              </button>
            }
          </div>

          @if (activeDocumentTabDefinition(); as tab) {
            <div class="grid gap-4 lg:grid-cols-2">
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                <div class="group flex items-center justify-between gap-2">
                  <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                    Documents attendus
                  </h4>
                  @if (activeTabHasHiddenExpectedDocuments()) {
                    <button
                      type="button"
                      class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 opacity-0 transition hover:bg-slate-100 focus:opacity-100 group-hover:opacity-100"
                      (click)="restoreHiddenExpectedDocumentsForTab(tab.id)"
                    >
                      Démasquer
                    </button>
                  }
                </div>

                @if (expectedDocumentsForActiveTab().length === 0) {
                  <p class="mt-3 text-sm text-slate-500">
                    Tous les documents attendus de cette catégorie sont masqués.
                  </p>
                } @else {
                  <ul class="mt-3 space-y-1 text-sm text-slate-700">
                    @for (expectedItem of expectedDocumentsForActiveTab(); track expectedItem.key) {
                      <li
                        class="group flex items-start justify-between gap-3 rounded-lg px-2 py-0.5 transition hover:bg-slate-100"
                      >
                        <div class="flex min-w-0 items-start gap-2">
                          @if (expectedItem.provided) {
                            <span
                              class="mt-0.5 inline-flex h-5 w-5 shrink-0 items-center justify-center rounded-full bg-emerald-100 text-xs font-semibold text-emerald-700"
                              aria-hidden="true"
                            >
                              ✓
                            </span>
                          } @else {
                            <span
                              class="mt-0.5 inline-flex h-5 w-5 shrink-0 items-center justify-center"
                              aria-hidden="true"
                            >
                              <span class="inline-block h-2 w-2 rounded-full bg-blue-500"></span>
                            </span>
                          }
                          <span class="leading-6">{{ expectedItem.label }}</span>
                        </div>
                        <button
                          type="button"
                          class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 opacity-0 transition hover:bg-slate-100 focus:opacity-100 group-hover:opacity-100"
                          (click)="hideExpectedDocument(tab.id, expectedItem.index)"
                        >
                          Masquer
                        </button>
                      </li>
                    }
                  </ul>
                }
              </article>

              <article class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Documents uploades
                </h4>

                @if (documentsForActiveTab().length === 0) {
                  <p class="mt-3 text-sm text-slate-500">Aucun document dans cette catégorie.</p>
                } @else {
                  <div class="mt-3 space-y-2">
                    @for (file of documentsForActiveTab(); track file.id) {
                      <article class="rounded-lg border border-slate-200 bg-white p-3">
                        <p class="text-sm font-semibold text-slate-900">{{ file.fileName }}</p>
                        <p class="text-xs uppercase tracking-[0.1em] text-slate-500">
                          {{ file.typeDocument || 'Type inconnu' }} · {{ formatSize(file.size) }}
                        </p>
                        <p class="mt-1 text-xs text-slate-500">Statut: {{ file.status }}</p>
                      </article>
                    }
                  </div>
                }
              </article>
            </div>
          }

          @if (uploadFeedback()) {
            <p
              class="rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
              role="status"
              aria-live="polite"
            >
              {{ uploadFeedback() }}
            </p>
          }
        </section>
      }

      @if (isMainTabActive('prospects')) {
        <section class="panel space-y-4 p-5">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <h3 class="text-xl font-semibold text-slate-900">Prospects du bien</h3>
            <button
              type="button"
              class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
              (click)="openProspectModal()"
            >
              Ajouter un prospect
            </button>
          </div>

          @if (prospectFeedback()) {
            <p
              class="rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
              role="status"
              aria-live="polite"
            >
              {{ prospectFeedback() }}
            </p>
          }

          @if (prospects().length === 0) {
            <p class="text-sm text-slate-600">Aucun prospect enregistre.</p>
          } @else {
            <section class="overflow-x-auto rounded-xl border border-slate-200">
              <table class="min-w-full border-collapse text-sm">
                <thead
                  class="bg-slate-100 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-600"
                >
                  <tr>
                    <th class="px-4 py-3">Nom</th>
                    <th class="px-4 py-3">Email</th>
                    <th class="px-4 py-3">Téléphone</th>
                    <th class="px-4 py-3">Lien</th>
                  </tr>
                </thead>
                <tbody>
                  @for (prospect of prospects(); track prospect.id) {
                    <tr class="border-t border-slate-200 align-top">
                      <td class="px-4 py-3">
                        <p class="font-semibold text-slate-900">
                          {{ prospectDisplayName(prospect) }}
                        </p>
                        <p class="mt-1 text-xs text-slate-500">
                          {{ prospectRelationLabel(prospect.relationRole) }}
                        </p>
                      </td>
                      <td class="px-4 py-3 text-slate-700">
                        {{ prospect.email || 'Non renseigné' }}
                      </td>
                      <td class="px-4 py-3 text-slate-700">
                        {{ prospect.phone || 'Non renseigné' }}
                      </td>
                      <td class="px-4 py-3">
                        <a
                          [routerLink]="['/app/utilisateurs', prospect.userId]"
                          class="text-slate-800 transition hover:text-blue-700"
                        >
                          Voir utilisateur
                        </a>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </section>
          }
        </section>
      }

      @if (isMainTabActive('visits')) {
        <section class="panel space-y-4 p-5">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <h3 class="text-xl font-semibold text-slate-900">Visites planifiées</h3>
            <button
              type="button"
              class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
              (click)="openVisitModal()"
            >
              Ajouter une visite
            </button>
          </div>

          @if (sortedVisits().length === 0) {
            <p class="text-sm text-slate-600">Aucune visite planifiée.</p>
          } @else {
            <section class="overflow-x-auto rounded-xl border border-slate-200">
              <table class="min-w-full border-collapse text-sm">
                <thead
                  class="bg-slate-100 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-600"
                >
                  <tr>
                    <th class="px-4 py-3">Prospect</th>
                    <th class="px-4 py-3">Debut</th>
                    <th class="px-4 py-3">Fin</th>
                    <th class="px-4 py-3">Contact</th>
                  </tr>
                </thead>
                <tbody>
                  @for (visit of sortedVisits(); track visit.id) {
                    <tr class="border-t border-slate-200 align-top">
                      <td class="px-4 py-3">
                        <p class="font-semibold text-slate-900">
                          {{ visit.prospectFirstName }} {{ visit.prospectLastName }}
                        </p>
                        <p class="mt-1 text-xs text-slate-500">
                          ID prospect: {{ visit.prospectUserId }}
                        </p>
                      </td>
                      <td class="px-4 py-3 text-slate-700">{{ visit.startsAt | date: 'short' }}</td>
                      <td class="px-4 py-3 text-slate-700">{{ visit.endsAt | date: 'short' }}</td>
                      <td class="px-4 py-3 text-slate-700">
                        {{ visit.prospectEmail || visit.prospectPhone || 'Non renseigné' }}
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </section>
          }
        </section>
      }

      @if (isMainTabActive('messages')) {
        <section class="panel space-y-4 p-5">
          <h3 class="text-xl font-semibold text-slate-900">Messages rattachés</h3>

          @if (messages().length === 0) {
            <p class="text-sm text-slate-600">Aucun message lie a ce bien.</p>
          } @else {
            <div class="space-y-3">
              @for (message of messages(); track message.id) {
                <article class="rounded-2xl border border-slate-200 bg-white p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    {{ message.channel }} · {{ message.receivedAt | date: 'short' }}
                  </p>
                  <p class="mt-1 font-semibold text-slate-900">
                    {{ message.subject || 'Sans objet' }}
                  </p>
                  <p class="text-sm text-slate-600">{{ message.body }}</p>
                  <p class="mt-1 text-xs font-semibold text-slate-500">
                    IA: {{ message.aiStatus }}
                  </p>
                </article>
              }
            </div>
          }
        </section>
      }

      @if (isMainTabActive('valuation')) {
        <section class="panel space-y-4 p-5">
          <article class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Georisques
              </h4>
              @if (risks(); as risksResponse) {
                <div class="flex flex-wrap items-center gap-2">
                  @if (risksResponse.reportPdfUrl) {
                    <a
                      [href]="risksResponse.reportPdfUrl"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                    >
                      Ouvrir le rapport PDF
                    </a>
                  }
                  <a
                    [href]="risksResponse.georisquesUrl"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                  >
                    Ouvrir Georisques
                  </a>
                </div>
              }
            </div>

            @if (risksLoading()) {
              <p class="mt-3 text-sm text-slate-600">Chargement des risques...</p>
            } @else if (risksError()) {
              <p
                class="mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700"
              >
                {{ risksError() }}
              </p>
            } @else if (risks()) {
            } @else {
              <p class="mt-3 text-sm text-slate-600">Les risques ne sont pas encore chargés.</p>
            }
          </article>

          @if (comparablesLoading()) {
            <p class="text-sm text-slate-600">Recherche des ventes en cours...</p>
          } @else if (comparablesError()) {
            <p class="rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
              {{ comparablesError() }}
            </p>
          } @else if (comparables(); as comparablesResponse) {
            <div class="grid gap-3 md:grid-cols-2 xl:grid-cols-4">
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Nb ventes
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  {{ comparablesDisplayedSummary().count }}
                </p>
              </article>
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Mediane prix / m2
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  @if (comparablesDisplayedSummary().medianPricePerM2 !== null) {
                    {{ comparablesDisplayedSummary().medianPricePerM2 | number: '1.0-0' }} €/m²
                  } @else {
                    N/A
                  }
                </p>
              </article>
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Prix predit
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  @if (comparablesFrontPricing(); as frontPricing) {
                    @if (frontPricing.predictedPrice !== null) {
                      {{ frontPricing.predictedPrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  } @else {
                    N/A
                  }
                </p>
              </article>
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Position prix
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  @if (comparablesFrontPricing(); as frontPricing) {
                    {{ comparablePricingLabel(frontPricing.pricingPosition) }}
                  } @else {
                    N/A
                  }
                </p>
                <p class="mt-3 text-sm text-slate-700">
                  Prix demandé:
                  <strong>
                    @if (comparablesResponse.subject.askingPrice !== null) {
                      {{ comparablesResponse.subject.askingPrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </strong>
                </p>
                <p class="text-sm text-slate-700">
                  Ecart:
                  <strong>
                    @if (comparablesFrontPricing(); as frontPricing) {
                      @if (frontPricing.deviationPct !== null) {
                        {{ frontPricing.deviationPct | number: '1.0-1' }} %
                      } @else {
                        N/A
                      }
                    } @else {
                      N/A
                    }
                  </strong>
                </p>
              </article>
            </div>

            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Filtres comparables
              </h4>
              <div class="mt-3 grid gap-4 lg:grid-cols-2">
                @if (comparablesSurfaceSlider(); as surfaceSlider) {
                  <div>
                    <div class="flex items-center justify-between gap-2 text-sm text-slate-700">
                      <span>Surface bien</span>
                      <strong>
                        {{ surfaceSlider.currentMin | number: '1.0-0' }} -
                        {{ surfaceSlider.currentMax | number: '1.0-0' }} m²
                      </strong>
                    </div>
                    <div class="dual-range mt-3">
                      <div class="dual-range__track"></div>
                      <div
                        class="dual-range__selection"
                        [style.left.%]="surfaceSlider.minPercent"
                        [style.width.%]="surfaceSlider.rangePercent"
                      ></div>
                      <span
                        class="range-marker"
                        [class.range-marker--hidden]="
                          sliderPercent(
                            comparableTargetSurfaceM2(),
                            surfaceSlider.min,
                            surfaceSlider.max
                          ) === null
                        "
                        [style.left.%]="
                          sliderPercent(
                            comparableTargetSurfaceM2(),
                            surfaceSlider.min,
                            surfaceSlider.max
                          )
                        "
                        title="Position du bien"
                        aria-hidden="true"
                      ></span>
                      <input
                        class="dual-range__input dual-range__input--min"
                        type="range"
                        [min]="surfaceSlider.min"
                        [max]="surfaceSlider.max"
                        [step]="1"
                        [value]="surfaceSlider.currentMin"
                        (input)="onComparableSurfaceMinChange($any($event.target).value)"
                      />
                      <input
                        class="dual-range__input dual-range__input--max"
                        type="range"
                        [min]="surfaceSlider.min"
                        [max]="surfaceSlider.max"
                        [step]="1"
                        [value]="surfaceSlider.currentMax"
                        (input)="onComparableSurfaceMaxChange($any($event.target).value)"
                      />
                    </div>
                  </div>
                }

                @if (comparablesResponse.propertyType === 'MAISON') {
                  @if (comparablesTerrainSlider(); as terrainSlider) {
                    <div>
                      <div class="flex items-center justify-between gap-2 text-sm text-slate-700">
                        <span>Surface terrain</span>
                        <strong>
                          {{ terrainSlider.currentMin | number: '1.0-0' }} -
                          {{ terrainSlider.currentMax | number: '1.0-0' }} m²
                        </strong>
                      </div>
                      <div class="dual-range mt-3">
                        <div class="dual-range__track"></div>
                        <div
                          class="dual-range__selection"
                          [style.left.%]="terrainSlider.minPercent"
                          [style.width.%]="terrainSlider.rangePercent"
                        ></div>
                        <span
                          class="range-marker"
                          [class.range-marker--hidden]="
                            sliderPercent(
                              comparableTargetLandSurfaceM2(),
                              terrainSlider.min,
                              terrainSlider.max
                            ) === null
                          "
                          [style.left.%]="
                            sliderPercent(
                              comparableTargetLandSurfaceM2(),
                              terrainSlider.min,
                              terrainSlider.max
                            )
                          "
                          title="Position du bien"
                          aria-hidden="true"
                        ></span>
                        <input
                          class="dual-range__input dual-range__input--min"
                          type="range"
                          [min]="terrainSlider.min"
                          [max]="terrainSlider.max"
                          [step]="1"
                          [value]="terrainSlider.currentMin"
                          (input)="onComparableTerrainMinChange($any($event.target).value)"
                        />
                        <input
                          class="dual-range__input dual-range__input--max"
                          type="range"
                          [min]="terrainSlider.min"
                          [max]="terrainSlider.max"
                          [step]="1"
                          [value]="terrainSlider.currentMax"
                          (input)="onComparableTerrainMaxChange($any($event.target).value)"
                        />
                      </div>
                    </div>
                  }
                }
              </div>
            </article>

            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Nuage surface/prix
              </h4>

              @if (filteredComparablePoints().length > 0) {
                <div class="mt-3 h-[420px] w-full">
                  <canvas #comparablesChartCanvas class="h-full w-full"></canvas>
                </div>

                @if (comparablesChartDomains(); as chartDomains) {
                  <div
                    class="mt-2 flex flex-wrap items-center justify-between gap-2 text-xs text-slate-600"
                  >
                    <span>Surface min: {{ chartDomains.xDomain.min | number: '1.0-0' }} m²</span>
                    <span>Surface max: {{ chartDomains.xDomain.max | number: '1.0-0' }} m²</span>
                    <span>Prix min: {{ chartDomains.yDomain.min | number: '1.0-0' }} €</span>
                    <span>Prix max: {{ chartDomains.yDomain.max | number: '1.0-0' }} €</span>
                  </div>
                }
              } @else {
                <p class="mt-3 text-sm text-slate-600">
                  Aucun point de vente disponible après filtres.
                </p>
              }
            </article>

            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Ventes
                </h4>
                @if (salesPagination(); as pagination) {
                  <span class="text-xs text-slate-600">{{ pagination.total }} ventes</span>
                }
              </div>

              @if (paginatedComparableSales().length > 0) {
                <div class="mt-3 overflow-x-auto">
                  <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50 text-xs uppercase tracking-[0.08em] text-slate-500">
                      <tr>
                        <th class="px-3 py-2 text-left">Date de vente</th>
                        <th class="px-3 py-2 text-left">Surface</th>
                        @if (comparablesResponse.propertyType === 'MAISON') {
                          <th class="px-3 py-2 text-left">Surface terrain</th>
                        }
                        <th class="px-3 py-2 text-left">Prix</th>
                        <th class="px-3 py-2 text-left">Prix / m²</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 bg-white">
                      @for (
                        sale of paginatedComparableSales();
                        track sale.saleDate + '-' + sale.salePrice + '-' + sale.surfaceM2
                      ) {
                        <tr>
                          <td class="px-3 py-2 text-slate-700">
                            @if (sale.saleDate) {
                              {{ sale.saleDate | date: 'shortDate' }}
                            } @else {
                              N/A
                            }
                          </td>
                          <td class="px-3 py-2 text-slate-700">
                            {{ sale.surfaceM2 | number: '1.0-0' }} m²
                          </td>
                          @if (comparablesResponse.propertyType === 'MAISON') {
                            <td class="px-3 py-2 text-slate-700">
                              @if (sale.landSurfaceM2 !== null) {
                                {{ sale.landSurfaceM2 | number: '1.0-0' }} m²
                              } @else {
                                N/A
                              }
                            </td>
                          }
                          <td class="px-3 py-2 font-semibold text-slate-900">
                            {{ sale.salePrice | number: '1.0-0' }} €
                          </td>
                          <td class="px-3 py-2 text-slate-700">
                            {{ sale.pricePerM2 | number: '1.0-0' }} €/m²
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>

                @if (salesPagination(); as pagination) {
                  @if (pagination.totalPages > 1) {
                    <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
                      <p class="text-xs text-slate-600">
                        Affichage {{ pagination.from }} - {{ pagination.to }} sur
                        {{ pagination.total }}
                      </p>
                      <div class="flex items-center gap-2">
                        <button
                          type="button"
                          class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-50"
                          [disabled]="pagination.page <= 1"
                          (click)="goToPreviousSalesPage()"
                        >
                          Precedent
                        </button>
                        <span class="text-xs text-slate-600"
                          >Page {{ pagination.page }} / {{ pagination.totalPages }}</span
                        >
                        <button
                          type="button"
                          class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-50"
                          [disabled]="pagination.page >= pagination.totalPages"
                          (click)="goToNextSalesPage()"
                        >
                          Suivant
                        </button>
                      </div>
                    </div>
                  }
                }
              } @else {
                <p class="mt-3 text-sm text-slate-600">Aucune vente disponible après filtres.</p>
              }
            </article>
          } @else {
            <p class="text-sm text-slate-600">Aucune donnée comparable chargée.</p>
          }

          @if (rentalProfitability(); as rental) {
            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Rentabilite location (TRI)
                </h4>
                <p class="text-xs text-slate-600">
                  Frais de notaire configures: {{ rental.notaryFeePct | number: '1.0-2' }} %
                </p>
              </div>

              <div class="mt-3 grid gap-3 md:grid-cols-3">
                <div>
                  <label class="field-label" for="rental-monthly-rent">Loyer mensuel (€)</label>
                  <input
                    id="rental-monthly-rent"
                    class="field-input"
                    type="number"
                    min="0"
                    step="10"
                    [value]="rental.monthlyRent ?? ''"
                    (input)="onRentalMonthlyRentChange($any($event.target).value)"
                  />
                </div>
                <div>
                  <label class="field-label" for="rental-holding-years"
                    >Duree de retention (annees)</label
                  >
                  <input
                    id="rental-holding-years"
                    class="field-input"
                    type="number"
                    min="1"
                    step="1"
                    [value]="rental.holdingYears ?? ''"
                    (input)="onRentalHoldingYearsChange($any($event.target).value)"
                  />
                </div>
                <div>
                  <label class="field-label" for="rental-resale-price">Prix de revente (€)</label>
                  <input
                    id="rental-resale-price"
                    class="field-input"
                    type="number"
                    min="1"
                    step="1000"
                    [value]="rental.resalePrice ?? ''"
                    (input)="onRentalResalePriceChange($any($event.target).value)"
                  />
                </div>
              </div>

              <div class="mt-3 grid gap-3 md:grid-cols-2 xl:grid-cols-4">
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">TRI</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.irrPct !== null) {
                      {{ rental.irrPct | number: '1.0-2' }} %
                    } @else {
                      N/A
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Investissement initial
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.initialInvestment !== null) {
                      {{ rental.initialInvestment | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Achat:
                    @if (rental.purchasePrice !== null) {
                      {{ rental.purchasePrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Notaire:
                    @if (rental.notaryFeeAmount !== null) {
                      {{ rental.notaryFeeAmount | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Flux net annuel</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.annualNetCashflow !== null) {
                      {{ rental.annualNetCashflow | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Taxe foncière: {{ rental.annualPropertyTax | number: '1.0-0' }} €
                  </p>
                  <p class="text-xs text-slate-600">
                    Frais copro: {{ rental.annualCoproFees | number: '1.0-0' }} €
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Hypothese de revente
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.resalePrice !== null) {
                      {{ rental.resalePrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">Duree: {{ rental.holdingYears ?? 'N/A' }} ans</p>
                  <p class="text-xs text-slate-600">
                    Loyer: {{ (rental.monthlyRent ?? 0) | number: '1.0-0' }} €/mois
                  </p>
                </div>
              </div>

              @if (rental.reason) {
                <p class="mt-3 rounded-xl bg-amber-50 px-3 py-2 text-sm text-amber-700">
                  {{ rental.reason }}
                </p>
              }
            </article>
          }

          <article class="rounded-xl border border-slate-200 bg-white p-4">
            <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
              Donnees INSEE
            </h4>
            @if (inseeLoading()) {
              <p class="mt-3 text-sm text-slate-600">Chargement des données INSEE...</p>
            } @else if (inseeError()) {
              <p
                class="mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700"
              >
                {{ inseeError() }}
              </p>
            } @else if (inseeModule(); as inseeData) {
              <div class="mt-3 grid gap-3 md:grid-cols-2 xl:grid-cols-4">
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Commune</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    {{ inseeData.city || 'N/A' }}
                  </p>
                  <p class="text-xs text-slate-600">
                    Code INSEE: {{ inseeData.inseeCode || 'N/A' }} · CP:
                    {{ inseeData.postalCode || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Evolution demographique
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.populationGrowthPct !== null) {
                      {{ inseeData.populationGrowthPct | number: '1.0-1' }} %
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    @if (
                      inseeData.populationStartYear !== null && inseeData.populationEndYear !== null
                    ) {
                      {{ inseeData.populationStartYear }} - {{ inseeData.populationEndYear }}
                    } @else {
                      Periode indisponible
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Croissance population
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.populationGrowthAbs !== null) {
                      {{ inseeData.populationGrowthAbs | number: '1.0-0' }} hab.
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Pop. actuelle:
                    @if (inseeData.populationCurrent !== null) {
                      {{ inseeData.populationCurrent | number: '1.0-0' }}
                    } @else {
                      N/A
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Revenu median</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.medianIncome !== null) {
                      {{ inseeData.medianIncome | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Annee: {{ inseeData.medianIncomeYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Taux de propriétaires
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.ownersRatePct !== null) {
                      {{ inseeData.ownersRatePct | number: '1.0-1' }} %
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    {{ inseeData.ownersRateScope || 'Zone indisponible' }} ·
                    {{ inseeData.ownersRateYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Taux de chomage</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.unemploymentRatePct !== null) {
                      {{ inseeData.unemploymentRatePct | number: '1.0-1' }} %
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Annee: {{ inseeData.unemploymentYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Age moyen</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.averageAge !== null) {
                      {{ inseeData.averageAge | number: '1.0-1' }} ans
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Annee: {{ inseeData.averageAgeYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Autres criteres</p>
                  <p class="text-sm text-slate-700">
                    Densite:
                    <strong>
                      @if (inseeData.populationDensityPerKm2 !== null) {
                        {{ inseeData.populationDensityPerKm2 | number: '1.0-0' }} hab./km²
                      } @else {
                        N/A
                      }
                    </strong>
                  </p>
                  <p class="text-sm text-slate-700">
                    Pauvrete:
                    <strong>
                      @if (inseeData.povertyRatePct !== null) {
                        {{ inseeData.povertyRatePct | number: '1.0-1' }} %
                      } @else {
                        N/A
                      }
                    </strong>
                  </p>
                  <p class="text-sm text-slate-700">
                    Gini:
                    <strong>
                      @if (inseeData.giniIndex !== null) {
                        {{ inseeData.giniIndex | number: '1.0-3' }}
                      } @else {
                        N/A
                      }
                    </strong>
                  </p>
                </div>
              </div>
              <p class="mt-3 text-xs text-slate-500">
                Sources: geo.api.gouv.fr, OpenDataSoft (INSEE).
              </p>
            } @else {
              <p class="mt-3 text-sm text-slate-600">Aucune donnée INSEE disponible.</p>
            }
          </article>
        </section>
      }
    </section>

    @if (vocalModalOpen()) {
      <div
        class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/45 p-4"
        role="dialog"
        aria-modal="true"
        aria-labelledby="vocal-modal-title"
        (click)="onVocalBackdropClick($event)"
      >
        <div class="w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-5 shadow-xl">
          <div class="flex items-start justify-between gap-2">
            <h3 id="vocal-modal-title" class="text-xl font-semibold text-slate-900">
              Créer un vocal
            </h3>
            <button
              type="button"
              class="rounded-lg border border-slate-300 px-2 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100"
              [disabled]="vocalPending()"
              (click)="closeVocalModal()"
            >
              Fermer
            </button>
          </div>

          <div class="mt-4 space-y-3">
            <p
              class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600"
            >
              Enregistrement depuis votre micro puis envoi automatique au backend avec le lien vers
              ce bien.
            </p>

            <div class="flex flex-wrap items-center gap-2">
              @if (!vocalRecording()) {
                <button
                  type="button"
                  class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700"
                  [disabled]="vocalPending()"
                  (click)="startVocalRecording()"
                >
                  Demarrer l'enregistrement
                </button>
              } @else {
                <button
                  type="button"
                  class="rounded-xl bg-red-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-red-700"
                  (click)="stopVocalRecording()"
                >
                  Arreter
                </button>
              }

              @if (recordedVocal()) {
                <button
                  type="button"
                  class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                  [disabled]="vocalPending()"
                  (click)="clearRecordedVocal()"
                >
                  Recommencer
                </button>
              }
            </div>

            @if (recordedVocalLabel()) {
              <p class="text-sm text-slate-700">{{ recordedVocalLabel() }}</p>
            }

            @if (vocalFeedback()) {
              <p
                class="rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
                role="status"
                aria-live="polite"
              >
                {{ vocalFeedback() }}
              </p>
            }

            <div class="flex items-center justify-end gap-2 pt-1">
              <button
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                [disabled]="vocalPending()"
                (click)="closeVocalModal()"
              >
                Annuler
              </button>
              <button
                class="rounded-xl bg-indigo-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                type="button"
                [disabled]="vocalPending() || vocalRecording() || !recordedVocal()"
                (click)="uploadVocalRecording()"
              >
                {{ vocalPending() ? 'Envoi...' : 'Envoyer le vocal' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    }

    @if (uploadModalOpen()) {
      <div
        class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/45 p-4"
        role="dialog"
        aria-modal="true"
        aria-labelledby="upload-modal-title"
        (click)="onUploadBackdropClick($event)"
      >
        <div class="w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-5 shadow-xl">
          <div class="flex items-start justify-between gap-2">
            <h3 id="upload-modal-title" class="text-xl font-semibold text-slate-900">
              Ajouter un document
            </h3>
            <button
              type="button"
              class="rounded-lg border border-slate-300 px-2 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100"
              (click)="closeUploadModal()"
            >
              Fermer
            </button>
          </div>

          <form
            class="mt-4 space-y-3"
            [formGroup]="uploadForm"
            (ngSubmit)="uploadFile()"
            novalidate
          >
            <div>
              <label class="field-label" for="upload-type">Type de document</label>
              <select id="upload-type" class="field-input" formControlName="typeDocument">
                @for (
                  typeDocument of activeDocumentTabDefinition().typeDocuments;
                  track typeDocument
                ) {
                  <option [value]="typeDocument">{{ typeDocument }}</option>
                }
              </select>
            </div>

            <div>
              <label class="field-label" for="upload-file">Fichier</label>
              <input
                id="upload-file"
                class="field-input"
                type="file"
                (change)="onFileInputChange($event)"
              />
              @if (selectedFileName()) {
                <p class="mt-1 text-xs text-slate-500">{{ selectedFileName() }}</p>
              }
            </div>

            @if (uploadFeedback()) {
              <p
                class="rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
                role="status"
                aria-live="polite"
              >
                {{ uploadFeedback() }}
              </p>
            }

            <div class="flex items-center justify-end gap-2 pt-1">
              <button
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                (click)="closeUploadModal()"
              >
                Annuler
              </button>

              <button
                class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                type="submit"
                [disabled]="uploadPending()"
              >
                {{ uploadPending() ? 'Upload...' : 'Ajouter' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    }

    @if (prospectModalOpen()) {
      <div
        class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/45 p-4"
        role="dialog"
        aria-modal="true"
        aria-labelledby="prospect-modal-title"
        (click)="onProspectBackdropClick($event)"
      >
        <div class="w-full max-w-2xl rounded-2xl border border-slate-200 bg-white p-5 shadow-xl">
          <div class="flex items-start justify-between gap-2">
            <h3 id="prospect-modal-title" class="text-xl font-semibold text-slate-900">
              Ajouter un prospect
            </h3>
            <button
              type="button"
              class="rounded-lg border border-slate-300 px-2 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100"
              (click)="closeProspectModal()"
            >
              Fermer
            </button>
          </div>

          <form
            class="mt-4 space-y-3"
            [formGroup]="prospectForm"
            (ngSubmit)="addProspect()"
            novalidate
          >
            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                class="rounded-xl px-3 py-2 text-sm font-semibold"
                [class.bg-blue-600]="prospectMode() === 'existing'"
                [class.text-white]="prospectMode() === 'existing'"
                [class.bg-slate-100]="prospectMode() !== 'existing'"
                [class.text-slate-700]="prospectMode() !== 'existing'"
                [attr.aria-pressed]="prospectMode() === 'existing' ? 'true' : 'false'"
                (click)="setProspectMode('existing')"
              >
                Client existant
              </button>
              <button
                type="button"
                class="rounded-xl px-3 py-2 text-sm font-semibold"
                [class.bg-blue-600]="prospectMode() === 'new'"
                [class.text-white]="prospectMode() === 'new'"
                [class.bg-slate-100]="prospectMode() !== 'new'"
                [class.text-slate-700]="prospectMode() !== 'new'"
                [attr.aria-pressed]="prospectMode() === 'new' ? 'true' : 'false'"
                (click)="setProspectMode('new')"
              >
                Nouveau client
              </button>
            </div>

            @if (prospectMode() === 'existing') {
              <div>
                <label class="field-label" [for]="prospectAutocompleteId">Client</label>
                <div
                  #prospectLookupContainer
                  class="relative"
                  role="combobox"
                  aria-haspopup="listbox"
                  [attr.aria-expanded]="prospectSuggestionsOpen() ? 'true' : 'false'"
                  [attr.aria-owns]="prospectAutocompleteListId"
                  [attr.aria-controls]="prospectAutocompleteListId"
                  (focusout)="onProspectLookupContainerFocusOut($event, prospectLookupContainer)"
                >
                  <input
                    [id]="prospectAutocompleteId"
                    class="field-input pr-11"
                    type="text"
                    formControlName="existingLookup"
                    placeholder="Nom ou email d'un client"
                    autocomplete="off"
                    [attr.aria-autocomplete]="'list'"
                    [attr.aria-controls]="prospectAutocompleteListId"
                    (focus)="onProspectLookupFocus()"
                    (input)="onProspectLookupInput($event)"
                  />
                  <button
                    type="button"
                    class="absolute right-2 top-1/2 -translate-y-1/2 rounded-md border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 transition hover:bg-slate-100"
                    aria-label="Afficher les clients"
                    (click)="toggleProspectSuggestions()"
                  >
                    ▾
                  </button>

                  @if (prospectSuggestionsOpen()) {
                    <ul
                      [id]="prospectAutocompleteListId"
                      class="absolute z-20 mt-1 max-h-56 w-full overflow-auto rounded-xl border border-slate-200 bg-white p-1 shadow-lg"
                      role="listbox"
                      tabindex="-1"
                    >
                      @for (client of filteredProspectClients(); track client.id) {
                        <li
                          role="option"
                          [attr.aria-selected]="
                            prospectForm.controls.userId.value === client.id ? 'true' : 'false'
                          "
                        >
                          <button
                            type="button"
                            class="w-full rounded-lg px-3 py-2 text-left text-sm text-slate-700 transition hover:bg-slate-100"
                            (mousedown)="onProspectSuggestionMouseDown($event)"
                            (click)="selectProspectClient(client)"
                          >
                            {{ prospectOptionLabel(client) }}
                          </button>
                        </li>
                      } @empty {
                        <li class="px-3 py-2 text-sm text-slate-500">Aucun client trouvé.</li>
                      }
                    </ul>
                  }
                </div>
                @if (clientsLoading()) {
                  <p class="mt-1 text-xs text-slate-500">Chargement des clients...</p>
                }
              </div>
            } @else {
              <div class="grid gap-3 sm:grid-cols-2">
                <div>
                  <label class="field-label" for="prospect-first-name">Prénom</label>
                  <input
                    id="prospect-first-name"
                    class="field-input"
                    type="text"
                    formControlName="firstName"
                  />
                </div>
                <div>
                  <label class="field-label" for="prospect-last-name">Nom</label>
                  <input
                    id="prospect-last-name"
                    class="field-input"
                    type="text"
                    formControlName="lastName"
                  />
                </div>
                <div>
                  <label class="field-label" for="prospect-phone">Téléphone</label>
                  <input
                    id="prospect-phone"
                    class="field-input"
                    type="text"
                    formControlName="phone"
                  />
                </div>
                <div>
                  <label class="field-label" for="prospect-email">Email</label>
                  <input
                    id="prospect-email"
                    class="field-input"
                    type="email"
                    formControlName="email"
                  />
                </div>
                <div class="sm:col-span-2">
                  <label class="field-label" for="prospect-address">Adresse</label>
                  <input
                    id="prospect-address"
                    class="field-input"
                    type="text"
                    formControlName="address"
                  />
                </div>
                <div>
                  <label class="field-label" for="prospect-postal">Code postal</label>
                  <input
                    id="prospect-postal"
                    class="field-input"
                    type="text"
                    formControlName="postalCode"
                  />
                </div>
                <div>
                  <label class="field-label" for="prospect-city">Ville</label>
                  <input
                    id="prospect-city"
                    class="field-input"
                    type="text"
                    formControlName="city"
                  />
                </div>
              </div>
            }

            @if (prospectFeedback()) {
              <p
                class="rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
                role="status"
                aria-live="polite"
              >
                {{ prospectFeedback() }}
              </p>
            }

            <div class="flex items-center justify-end gap-2 pt-1">
              <button
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                (click)="closeProspectModal()"
              >
                Annuler
              </button>
              <button
                class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                type="submit"
                [disabled]="prospectPending()"
              >
                {{ prospectPending() ? 'Ajout...' : 'Ajouter' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    }

    @if (visitModalOpen()) {
      <div
        class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/45 p-4"
        role="dialog"
        aria-modal="true"
        aria-labelledby="visit-modal-title"
        (click)="onVisitBackdropClick($event)"
      >
        <div class="w-full max-w-2xl rounded-2xl border border-slate-200 bg-white p-5 shadow-xl">
          <div class="flex items-start justify-between gap-2">
            <h3 id="visit-modal-title" class="text-xl font-semibold text-slate-900">
              Ajouter une visite
            </h3>
            <button
              type="button"
              class="rounded-lg border border-slate-300 px-2 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100"
              (click)="closeVisitModal()"
            >
              Fermer
            </button>
          </div>

          <form class="mt-4 space-y-3" [formGroup]="visitForm" (ngSubmit)="addVisit()" novalidate>
            <div class="grid gap-3 sm:grid-cols-2">
              <div>
                <label class="field-label" for="visit-start">Heure début visite</label>
                <input
                  id="visit-start"
                  class="field-input"
                  type="datetime-local"
                  formControlName="startsAt"
                  (input)="onVisitStartInput($event)"
                />
              </div>
              <div>
                <label class="field-label" for="visit-end">Heure fin visite</label>
                <input
                  id="visit-end"
                  class="field-input"
                  type="datetime-local"
                  formControlName="endsAt"
                />
              </div>
            </div>

            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                class="rounded-xl px-3 py-2 text-sm font-semibold"
                [class.bg-blue-600]="visitProspectMode() === 'existing'"
                [class.text-white]="visitProspectMode() === 'existing'"
                [class.bg-slate-100]="visitProspectMode() !== 'existing'"
                [class.text-slate-700]="visitProspectMode() !== 'existing'"
                [attr.aria-pressed]="visitProspectMode() === 'existing' ? 'true' : 'false'"
                (click)="setVisitProspectMode('existing')"
              >
                Client existant
              </button>
              <button
                type="button"
                class="rounded-xl px-3 py-2 text-sm font-semibold"
                [class.bg-blue-600]="visitProspectMode() === 'new'"
                [class.text-white]="visitProspectMode() === 'new'"
                [class.bg-slate-100]="visitProspectMode() !== 'new'"
                [class.text-slate-700]="visitProspectMode() !== 'new'"
                [attr.aria-pressed]="visitProspectMode() === 'new' ? 'true' : 'false'"
                (click)="setVisitProspectMode('new')"
              >
                Nouveau client
              </button>
            </div>

            @if (visitProspectMode() === 'existing') {
              <div>
                <label class="field-label" [for]="visitAutocompleteId">Client</label>
                <div
                  #visitLookupContainer
                  class="relative"
                  role="combobox"
                  aria-haspopup="listbox"
                  [attr.aria-expanded]="visitSuggestionsOpen() ? 'true' : 'false'"
                  [attr.aria-owns]="visitAutocompleteListId"
                  [attr.aria-controls]="visitAutocompleteListId"
                  (focusout)="onVisitLookupContainerFocusOut($event, visitLookupContainer)"
                >
                  <input
                    [id]="visitAutocompleteId"
                    class="field-input pr-11"
                    type="text"
                    formControlName="existingLookup"
                    placeholder="Nom ou email d'un client"
                    autocomplete="off"
                    [attr.aria-autocomplete]="'list'"
                    [attr.aria-controls]="visitAutocompleteListId"
                    (focus)="onVisitLookupFocus()"
                    (input)="onVisitLookupInput($event)"
                  />
                  <button
                    type="button"
                    class="absolute right-2 top-1/2 -translate-y-1/2 rounded-md border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 transition hover:bg-slate-100"
                    aria-label="Afficher les clients"
                    (click)="toggleVisitSuggestions()"
                  >
                    ▾
                  </button>

                  @if (visitSuggestionsOpen()) {
                    <ul
                      [id]="visitAutocompleteListId"
                      class="absolute z-20 mt-1 max-h-56 w-full overflow-auto rounded-xl border border-slate-200 bg-white p-1 shadow-lg"
                      role="listbox"
                      tabindex="-1"
                    >
                      @for (client of filteredVisitClients(); track client.id) {
                        <li
                          role="option"
                          [attr.aria-selected]="
                            visitForm.controls.userId.value === client.id ? 'true' : 'false'
                          "
                        >
                          <button
                            type="button"
                            class="w-full rounded-lg px-3 py-2 text-left text-sm text-slate-700 transition hover:bg-slate-100"
                            (mousedown)="onVisitSuggestionMouseDown($event)"
                            (click)="selectVisitClient(client)"
                          >
                            {{ prospectOptionLabel(client) }}
                          </button>
                        </li>
                      } @empty {
                        <li class="px-3 py-2 text-sm text-slate-500">Aucun client trouvé.</li>
                      }
                    </ul>
                  }
                </div>
                @if (clientsLoading()) {
                  <p class="mt-1 text-xs text-slate-500">Chargement des clients...</p>
                }
              </div>
            } @else {
              <div class="grid gap-3 sm:grid-cols-2">
                <div>
                  <label class="field-label" for="visit-prospect-first-name">Prénom</label>
                  <input
                    id="visit-prospect-first-name"
                    class="field-input"
                    type="text"
                    formControlName="firstName"
                  />
                </div>
                <div>
                  <label class="field-label" for="visit-prospect-last-name">Nom</label>
                  <input
                    id="visit-prospect-last-name"
                    class="field-input"
                    type="text"
                    formControlName="lastName"
                  />
                </div>
                <div>
                  <label class="field-label" for="visit-prospect-phone">Téléphone</label>
                  <input
                    id="visit-prospect-phone"
                    class="field-input"
                    type="text"
                    formControlName="phone"
                  />
                </div>
                <div>
                  <label class="field-label" for="visit-prospect-email">Email</label>
                  <input
                    id="visit-prospect-email"
                    class="field-input"
                    type="email"
                    formControlName="email"
                  />
                </div>
                <div class="sm:col-span-2">
                  <label class="field-label" for="visit-prospect-address">Adresse</label>
                  <input
                    id="visit-prospect-address"
                    class="field-input"
                    type="text"
                    formControlName="address"
                  />
                </div>
                <div>
                  <label class="field-label" for="visit-prospect-postal">Code postal</label>
                  <input
                    id="visit-prospect-postal"
                    class="field-input"
                    type="text"
                    formControlName="postalCode"
                  />
                </div>
                <div>
                  <label class="field-label" for="visit-prospect-city">Ville</label>
                  <input
                    id="visit-prospect-city"
                    class="field-input"
                    type="text"
                    formControlName="city"
                  />
                </div>
              </div>
            }

            @if (visitFeedback()) {
              <p
                class="rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
                role="status"
                aria-live="polite"
              >
                {{ visitFeedback() }}
              </p>
            }

            <div class="flex items-center justify-end gap-2 pt-1">
              <button
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                (click)="closeVisitModal()"
              >
                Annuler
              </button>
              <button
                class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                type="submit"
                [disabled]="visitPending()"
              >
                {{ visitPending() ? 'Ajout...' : 'Ajouter' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    }
  }
}
