        <section class="panel space-y-4 p-5">
          <article class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Georisques
              </h4>
              @if (host.risks(); as risksResponse) {
                <div class="flex flex-wrap items-center gap-2">
                  @if (risksResponse.reportPdfUrl) {
                    <a
                      [href]="risksResponse.reportPdfUrl"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                    >
                      Ouvrir le rapport PDF
                    </a>
                  }
                  <a
                    [href]="risksResponse.georisquesUrl"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                  >
                    Ouvrir Georisques
                  </a>
                </div>
              }
            </div>

            @if (host.risksLoading()) {
              <p class="mt-3 text-sm text-slate-600">Chargement des risques...</p>
            } @else if (host.risksError()) {
              <p
                class="mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700"
              >
                {{ host.risksError() }}
              </p>
            } @else if (host.risks()) {
            } @else {
              <p class="mt-3 text-sm text-slate-600">Les risques ne sont pas encore chargés.</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Avis agent sur la valorisation
              </h4>
              <span class="text-xs text-slate-500">Prix proposé + justificatif</span>
            </div>

            <p class="mt-2 text-xs uppercase tracking-[0.12em] text-slate-500">Critères clés (aperçu)</p>

            @if (host.valuationKeyCriteria().length > 0) {
              <div class="mt-3 grid gap-2 md:grid-cols-2 xl:grid-cols-5">
                @for (criterion of host.valuationKeyCriteria(); track criterion.categoryId + '-' + criterion.field.key) {
                  <article class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                    <p class="text-xs uppercase tracking-[0.12em] text-slate-500">{{ criterion.field.label }}</p>
                    <p class="mt-1 text-sm font-semibold text-slate-900">{{ criterion.value }}</p>
                  </article>
                }
              </div>
            } @else {
              <p class="mt-3 text-sm text-slate-600">
                Aucun critère principal renseigné (DPE, standing, surface, pièces, état général).
              </p>
            }

            <div class="mt-4 flex flex-wrap items-end gap-3">
              <div class="min-w-[220px] flex-1">
                <label class="field-label" for="valuation-sale-price">Prix de vente proposé (€)</label>
                <input
                  id="valuation-sale-price"
                  class="field-input"
                  type="number"
                  min="1"
                  step="1000"
                  [value]="host.valuationSalePriceInput()"
                  (input)="host.onValuationSalePriceInput($any($event.target).value)"
                />
              </div>
            </div>

            <div class="mt-3">
              <label class="field-label" for="valuation-agent-justification">
                Justificatif de la valorisation (agent)
              </label>
              <textarea
                id="valuation-agent-justification"
                class="field-input min-h-32"
                [value]="host.valuationAgentJustificationInput()"
                (input)="host.onValuationAgentJustificationInput($any($event.target).value)"
              ></textarea>
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-2">
              <button
                type="button"
                class="rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-60"
                [disabled]="host.valuationAgentOpinionSaving()"
                (click)="host.saveValuationAgentOpinion()"
              >
                {{ host.valuationAgentOpinionSaving() ? "Enregistrement..." : "Enregistrer l'avis agent" }}
              </button>
            </div>

            @if (host.valuationSalePriceFeedback()) {
              <p class="mt-2 text-sm text-slate-600">{{ host.valuationSalePriceFeedback() }}</p>
            }
            @if (host.valuationAgentOpinionFeedback()) {
              <p class="mt-2 text-sm text-slate-600">{{ host.valuationAgentOpinionFeedback() }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Avis IA sur la valorisation
              </h4>
              @if (host.valuationAiSnapshot(); as aiSnapshot) {
                <span class="text-xs text-slate-500">
                  Dernière analyse: {{ aiSnapshot.generatedAt | date: 'short' }}
                </span>
              }
            </div>

            <div class="mt-3 grid gap-3 md:grid-cols-2">
              <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Valorisation calculée par l'IA</p>
                <p class="mt-1 text-base font-semibold text-slate-900">
                  @if (host.valuationAiSnapshot(); as aiSnapshot) {
                    @if (aiSnapshot.aiCalculatedValuation !== null) {
                      {{ aiSnapshot.aiCalculatedValuation | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  } @else {
                    N/A
                  }
                </p>
              </div>
              <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Ventes comparables utilisées</p>
                <p class="mt-1 text-base font-semibold text-slate-900">
                  @if (host.valuationAiSnapshot(); as aiSnapshot) {
                    {{ aiSnapshot.comparableCountUsed }}
                  } @else {
                    N/A
                  }
                </p>
              </div>
            </div>

            <div class="mt-3">
              <p class="field-label mb-2">Justificatif de la valorisation</p>
              <div class="ai-readonly-panel ai-readonly-panel--justification">
                @if (host.valuationAiJustificationHtml()) {
                  <div class="markdown-output" [innerHTML]="host.valuationAiJustificationHtml()"></div>
                } @else {
                  <p class="text-sm text-slate-500">Lancez l'analyse IA pour obtenir un justificatif.</p>
                }
              </div>
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-2">
              <button
                type="button"
                class="rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-60"
                [disabled]="host.valuationAiPending()"
                (click)="host.rerunValuationAnalysis()"
              >
                {{ host.valuationAiPending() ? "Analyse en cours..." : "Refaire l'analyse" }}
              </button>
              <button
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                [disabled]="!host.property() || host.valuationAiPromptPending()"
                (click)="host.toggleValuationPromptVisibility()"
              >
                {{ host.valuationAiPromptPending() ? "Chargement du prompt..." : "Prompt utilisé" }}
              </button>
            </div>

            @if (host.valuationAiPromptVisible()) {
              <div class="mt-3">
                <p class="field-label mb-2">Prompt utilisé</p>
                <pre class="ai-readonly-panel ai-readonly-panel--prompt">{{
                  host.valuationAiPromptText() || "Aucun prompt disponible."
                }}</pre>
              </div>
            }

            @if (host.valuationAiFeedback()) {
              <p class="mt-2 text-sm text-slate-600">{{ host.valuationAiFeedback() }}</p>
            }
          </article>

          @if (host.comparablesLoading()) {
            <p class="text-sm text-slate-600">Recherche des ventes en cours...</p>
          } @else if (host.comparablesError()) {
            <p class="rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
              {{ host.comparablesError() }}
            </p>
          } @else if (host.comparables(); as comparablesResponse) {
            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Filtres comparables
              </h4>
              <div class="mt-3 grid gap-4 lg:grid-cols-2">
                @if (host.comparablesSurfaceSlider(); as surfaceSlider) {
                  <div>
                    <div class="flex items-center justify-between gap-2 text-sm text-slate-700">
                      <span>Surface bien</span>
                      <strong>
                        {{ surfaceSlider.currentMin | number: '1.0-0' }} -
                        {{ surfaceSlider.currentMax | number: '1.0-0' }} m²
                      </strong>
                    </div>
                    <div class="dual-range mt-3">
                      <div class="dual-range__track"></div>
                      <div
                        class="dual-range__selection"
                        [style.left.%]="surfaceSlider.minPercent"
                        [style.width.%]="surfaceSlider.rangePercent"
                      ></div>
                      <span
                        class="range-marker"
                        [class.range-marker--hidden]="
                          host.sliderPercent(
                            host.comparableTargetSurfaceM2(),
                            surfaceSlider.min,
                            surfaceSlider.max
                          ) === null
                        "
                        [style.left.%]="
                          host.sliderPercent(
                            host.comparableTargetSurfaceM2(),
                            surfaceSlider.min,
                            surfaceSlider.max
                          )
                        "
                        title="Position du bien"
                        aria-hidden="true"
                      ></span>
                      <input
                        class="dual-range__input dual-range__input--min"
                        type="range"
                        [min]="surfaceSlider.min"
                        [max]="surfaceSlider.max"
                        [step]="1"
                        [value]="surfaceSlider.currentMin"
                        (input)="host.onComparableSurfaceMinChange($any($event.target).value)"
                      />
                      <input
                        class="dual-range__input dual-range__input--max"
                        type="range"
                        [min]="surfaceSlider.min"
                        [max]="surfaceSlider.max"
                        [step]="1"
                        [value]="surfaceSlider.currentMax"
                        (input)="host.onComparableSurfaceMaxChange($any($event.target).value)"
                      />
                    </div>
                  </div>
                }

                @if (comparablesResponse.propertyType === 'MAISON') {
                  @if (host.comparablesTerrainSlider(); as terrainSlider) {
                    <div>
                      <div class="flex items-center justify-between gap-2 text-sm text-slate-700">
                        <span>Surface terrain</span>
                        <strong>
                          {{ terrainSlider.currentMin | number: '1.0-0' }} -
                          {{ terrainSlider.currentMax | number: '1.0-0' }} m²
                        </strong>
                      </div>
                      <div class="dual-range mt-3">
                        <div class="dual-range__track"></div>
                        <div
                          class="dual-range__selection"
                          [style.left.%]="terrainSlider.minPercent"
                          [style.width.%]="terrainSlider.rangePercent"
                        ></div>
                        <span
                          class="range-marker"
                          [class.range-marker--hidden]="
                            host.sliderPercent(
                              host.comparableTargetLandSurfaceM2(),
                              terrainSlider.min,
                              terrainSlider.max
                            ) === null
                          "
                          [style.left.%]="
                            host.sliderPercent(
                              host.comparableTargetLandSurfaceM2(),
                              terrainSlider.min,
                              terrainSlider.max
                            )
                          "
                          title="Position du bien"
                          aria-hidden="true"
                        ></span>
                        <input
                          class="dual-range__input dual-range__input--min"
                          type="range"
                          [min]="terrainSlider.min"
                          [max]="terrainSlider.max"
                          [step]="1"
                          [value]="terrainSlider.currentMin"
                          (input)="host.onComparableTerrainMinChange($any($event.target).value)"
                        />
                        <input
                          class="dual-range__input dual-range__input--max"
                          type="range"
                          [min]="terrainSlider.min"
                          [max]="terrainSlider.max"
                          [step]="1"
                          [value]="terrainSlider.currentMax"
                          (input)="host.onComparableTerrainMaxChange($any($event.target).value)"
                        />
                      </div>
                    </div>
                  }
                }
              </div>
            </article>

            <div class="grid gap-3 md:grid-cols-2 xl:grid-cols-4">
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Nb ventes ({{ comparablesResponse.windowYears }} ans)
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  {{ host.comparablesDisplayedSummary().count }}
                </p>
                <p class="mt-1 text-xs text-slate-600">
                  5 dernières années: {{ host.marketTrendSalesCount() }}
                </p>
              </article>
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Mediane prix / m2
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  @if (host.comparablesDisplayedSummary().medianPricePerM2 !== null) {
                    {{ host.comparablesDisplayedSummary().medianPricePerM2 | number: '1.0-0' }} €/m²
                  } @else {
                    N/A
                  }
                </p>
              </article>
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Prix predit
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  @if (host.comparablesFrontPricing(); as frontPricing) {
                    @if (frontPricing.predictedPrice !== null) {
                      {{ frontPricing.predictedPrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  } @else {
                    N/A
                  }
                </p>
              </article>
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Position prix
                </p>
                <p class="mt-2 text-2xl font-semibold text-slate-900">
                  @if (host.comparablesFrontPricing(); as frontPricing) {
                    {{ host.comparablePricingLabel(frontPricing.pricingPosition) }}
                  } @else {
                    N/A
                  }
                </p>
                <p class="mt-3 text-sm text-slate-700">
                  Prix demandé:
                  <strong>
                    @if (comparablesResponse.subject.askingPrice !== null) {
                      {{ comparablesResponse.subject.askingPrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </strong>
                </p>
                <p class="text-sm text-slate-700">
                  Ecart:
                  <strong>
                    @if (host.comparablesFrontPricing(); as frontPricing) {
                      @if (frontPricing.deviationPct !== null) {
                        {{ frontPricing.deviationPct | number: '1.0-1' }} %
                      } @else {
                        N/A
                      }
                    } @else {
                      N/A
                    }
                  </strong>
                </p>
              </article>
            </div>

            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Tendance du marché (5 dernières années)
              </h4>
              <p class="mt-2 text-xs text-slate-600">
                Total du tableau: {{ host.marketTrendSalesCount() }} ventes (sur
                {{ host.comparablesDisplayedSummary().count }} comparables filtrés).
              </p>
              <div class="mt-3 overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                  <thead class="bg-slate-50 text-xs uppercase tracking-[0.08em] text-slate-500">
                    <tr>
                      <th class="px-3 py-2 text-left">Indicateur</th>
                      @for (yearRow of host.marketTrendRows(); track yearRow.year) {
                        <th class="px-3 py-2 text-right">{{ yearRow.year }}</th>
                      }
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 bg-white">
                    <tr>
                      <th class="px-3 py-2 text-left font-semibold text-slate-700">Nb ventes</th>
                      @for (yearRow of host.marketTrendRows(); track yearRow.year) {
                        <td class="px-3 py-2 text-right align-top">
                          <p class="font-semibold text-slate-900">
                            {{ yearRow.salesCount | number: '1.0-0' }}
                          </p>
                          <p
                            class="text-xs font-medium"
                            [ngClass]="host.variationClass(yearRow.salesCountVariationPct)"
                          >
                            @if (yearRow.salesCountVariationPct !== null) {
                              ({{ yearRow.salesCountVariationPct > 0 ? '+' : '' }}{{
                                yearRow.salesCountVariationPct | number: '1.0-1'
                              }}
                              %)
                            } @else {
                              (N/A)
                            }
                          </p>
                        </td>
                      }
                    </tr>
                    <tr>
                      <th class="px-3 py-2 text-left font-semibold text-slate-700">Prix moyen m²</th>
                      @for (yearRow of host.marketTrendRows(); track yearRow.year) {
                        <td class="px-3 py-2 text-right align-top">
                          <p class="font-semibold text-slate-900">
                            @if (yearRow.avgPricePerM2 !== null) {
                              {{ yearRow.avgPricePerM2 | number: '1.0-0' }} €/m²
                            } @else {
                              N/A
                            }
                          </p>
                          <p
                            class="text-xs font-medium"
                            [ngClass]="host.variationClass(yearRow.avgPricePerM2VariationPct)"
                          >
                            @if (yearRow.avgPricePerM2VariationPct !== null) {
                              ({{ yearRow.avgPricePerM2VariationPct > 0 ? '+' : '' }}{{
                                yearRow.avgPricePerM2VariationPct | number: '1.0-1'
                              }}
                              %)
                            } @else {
                              (N/A)
                            }
                          </p>
                        </td>
                      }
                    </tr>
                  </tbody>
                </table>
              </div>
            </article>

            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                Nuage surface/prix
              </h4>

              @if (host.filteredComparablePoints().length > 0) {
                <div class="mt-3 h-[420px] w-full">
                  <canvas #comparablesChartCanvas class="h-full w-full"></canvas>
                </div>

                <div class="mt-2 flex flex-wrap items-center justify-between gap-2 text-xs text-slate-600">
                  <span>
                    Surface min:
                    @if (host.comparablesDisplayedSurfaceRange(); as surfaceRange) {
                      {{ surfaceRange.min | number: '1.0-0' }} m²
                    } @else {
                      N/A
                    }
                  </span>
                  <span>
                    Surface max:
                    @if (host.comparablesDisplayedSurfaceRange(); as surfaceRange) {
                      {{ surfaceRange.max | number: '1.0-0' }} m²
                    } @else {
                      N/A
                    }
                  </span>
                  <span>
                    Prix min:
                    @if (host.comparablesDisplayedSummary().minPrice !== null) {
                      {{ host.comparablesDisplayedSummary().minPrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </span>
                  <span>
                    Prix max:
                    @if (host.comparablesDisplayedSummary().maxPrice !== null) {
                      {{ host.comparablesDisplayedSummary().maxPrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </span>
                </div>
              } @else {
                <p class="mt-3 text-sm text-slate-600">
                  Aucun point de vente disponible après filtres.
                </p>
              }
            </article>

            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Ventes
                </h4>
                @if (host.salesPagination(); as pagination) {
                  <span class="text-xs text-slate-600">{{ pagination.total }} ventes</span>
                }
              </div>

              @if (host.paginatedComparableSales().length > 0) {
                <div class="mt-3 overflow-x-auto">
                  <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50 text-xs uppercase tracking-[0.08em] text-slate-500">
                      <tr>
                        <th class="px-3 py-2 text-left" [attr.aria-sort]="host.comparableSalesAriaSort('saleDate')">
                          <button
                            type="button"
                            class="inline-flex items-center gap-1 rounded text-left font-semibold text-slate-600 transition hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
                            (click)="host.sortComparableSalesBy('saleDate')"
                          >
                            Date de vente
                            <span aria-hidden="true">{{ host.comparableSalesSortIndicator('saleDate') }}</span>
                          </button>
                        </th>
                        <th class="px-3 py-2 text-left" [attr.aria-sort]="host.comparableSalesAriaSort('surfaceM2')">
                          <button
                            type="button"
                            class="inline-flex items-center gap-1 rounded text-left font-semibold text-slate-600 transition hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
                            (click)="host.sortComparableSalesBy('surfaceM2')"
                          >
                            Surface
                            <span aria-hidden="true">{{ host.comparableSalesSortIndicator('surfaceM2') }}</span>
                          </button>
                        </th>
                        @if (comparablesResponse.propertyType === 'MAISON') {
                          <th
                            class="px-3 py-2 text-left"
                            [attr.aria-sort]="host.comparableSalesAriaSort('landSurfaceM2')"
                          >
                            <button
                              type="button"
                              class="inline-flex items-center gap-1 rounded text-left font-semibold text-slate-600 transition hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
                              (click)="host.sortComparableSalesBy('landSurfaceM2')"
                            >
                              Surface terrain
                              <span aria-hidden="true">{{
                                host.comparableSalesSortIndicator('landSurfaceM2')
                              }}</span>
                            </button>
                          </th>
                        }
                        <th class="px-3 py-2 text-left" [attr.aria-sort]="host.comparableSalesAriaSort('salePrice')">
                          <button
                            type="button"
                            class="inline-flex items-center gap-1 rounded text-left font-semibold text-slate-600 transition hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
                            (click)="host.sortComparableSalesBy('salePrice')"
                          >
                            Prix
                            <span aria-hidden="true">{{ host.comparableSalesSortIndicator('salePrice') }}</span>
                          </button>
                        </th>
                        <th class="px-3 py-2 text-left" [attr.aria-sort]="host.comparableSalesAriaSort('pricePerM2')">
                          <button
                            type="button"
                            class="inline-flex items-center gap-1 rounded text-left font-semibold text-slate-600 transition hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
                            (click)="host.sortComparableSalesBy('pricePerM2')"
                          >
                            Prix / m²
                            <span aria-hidden="true">{{ host.comparableSalesSortIndicator('pricePerM2') }}</span>
                          </button>
                        </th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 bg-white">
                      @for (
                        sale of host.paginatedComparableSales();
                        track sale.saleDate + '-' + sale.salePrice + '-' + sale.surfaceM2
                      ) {
                        <tr>
                          <td class="px-3 py-2 text-slate-700">
                            @if (sale.saleDate) {
                              {{ sale.saleDate | date: 'shortDate' }}
                            } @else {
                              N/A
                            }
                          </td>
                          <td class="px-3 py-2 text-slate-700">
                            {{ sale.surfaceM2 | number: '1.0-0' }} m²
                          </td>
                          @if (comparablesResponse.propertyType === 'MAISON') {
                            <td class="px-3 py-2 text-slate-700">
                              @if (sale.landSurfaceM2 !== null) {
                                {{ sale.landSurfaceM2 | number: '1.0-0' }} m²
                              } @else {
                                N/A
                              }
                            </td>
                          }
                          <td class="px-3 py-2 font-semibold text-slate-900">
                            {{ sale.salePrice | number: '1.0-0' }} €
                          </td>
                          <td class="px-3 py-2 text-slate-700">
                            {{ sale.pricePerM2 | number: '1.0-0' }} €/m²
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>

                @if (host.salesPagination(); as pagination) {
                  @if (pagination.totalPages > 1) {
                    <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
                      <p class="text-xs text-slate-600">
                        Affichage {{ pagination.from }} - {{ pagination.to }} sur
                        {{ pagination.total }}
                      </p>
                      <div class="flex items-center gap-2">
                        <button
                          type="button"
                          class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-50"
                          [disabled]="pagination.page <= 1"
                          (click)="host.goToPreviousSalesPage()"
                        >
                          Precedent
                        </button>
                        <span class="text-xs text-slate-600"
                          >Page {{ pagination.page }} / {{ pagination.totalPages }}</span
                        >
                        <button
                          type="button"
                          class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-50"
                          [disabled]="pagination.page >= pagination.totalPages"
                          (click)="host.goToNextSalesPage()"
                        >
                          Suivant
                        </button>
                      </div>
                    </div>
                  }
                }
              } @else {
                <p class="mt-3 text-sm text-slate-600">Aucune vente disponible après filtres.</p>
              }
            </article>
          } @else {
            <p class="text-sm text-slate-600">Aucune donnée comparable chargée.</p>
          }

          @if (host.rentalProfitability(); as rental) {
            <article class="rounded-xl border border-slate-200 bg-white p-4">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
                  Rentabilite location (TRI)
                </h4>
                <p class="text-xs text-slate-600">
                  Frais de notaire configures: {{ rental.notaryFeePct | number: '1.0-2' }} %
                </p>
              </div>

              <div class="mt-3 grid gap-3 md:grid-cols-3">
                <div>
                  <label class="field-label" for="rental-monthly-rent">Loyer mensuel (€)</label>
                  <input
                    id="rental-monthly-rent"
                    class="field-input"
                    type="number"
                    min="0"
                    step="10"
                    [value]="rental.monthlyRent ?? ''"
                    (input)="host.onRentalMonthlyRentChange($any($event.target).value)"
                  />
                </div>
                <div>
                  <label class="field-label" for="rental-holding-years"
                    >Duree de retention (annees)</label
                  >
                  <input
                    id="rental-holding-years"
                    class="field-input"
                    type="number"
                    min="1"
                    step="1"
                    [value]="rental.holdingYears ?? ''"
                    (input)="host.onRentalHoldingYearsChange($any($event.target).value)"
                  />
                </div>
                <div>
                  <label class="field-label" for="rental-resale-price">Prix de revente (€)</label>
                  <input
                    id="rental-resale-price"
                    class="field-input"
                    type="number"
                    min="1"
                    step="1000"
                    [value]="rental.resalePrice ?? ''"
                    (input)="host.onRentalResalePriceChange($any($event.target).value)"
                  />
                </div>
              </div>

              <div class="mt-3 grid gap-3 md:grid-cols-2 xl:grid-cols-4">
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">TRI</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.irrPct !== null) {
                      {{ rental.irrPct | number: '1.0-2' }} %
                    } @else {
                      N/A
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Investissement initial
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.initialInvestment !== null) {
                      {{ rental.initialInvestment | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Achat:
                    @if (rental.purchasePrice !== null) {
                      {{ rental.purchasePrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Notaire:
                    @if (rental.notaryFeeAmount !== null) {
                      {{ rental.notaryFeeAmount | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Flux net annuel</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.annualNetCashflow !== null) {
                      {{ rental.annualNetCashflow | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Taxe foncière: {{ rental.annualPropertyTax | number: '1.0-0' }} €
                  </p>
                  <p class="text-xs text-slate-600">
                    Frais copro: {{ rental.annualCoproFees | number: '1.0-0' }} €
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Hypothese de revente
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (rental.resalePrice !== null) {
                      {{ rental.resalePrice | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">Duree: {{ rental.holdingYears ?? 'N/A' }} ans</p>
                  <p class="text-xs text-slate-600">
                    Loyer: {{ (rental.monthlyRent ?? 0) | number: '1.0-0' }} €/mois
                  </p>
                </div>
              </div>

              @if (rental.reason) {
                <p class="mt-3 rounded-xl bg-amber-50 px-3 py-2 text-sm text-amber-700">
                  {{ rental.reason }}
                </p>
              }
            </article>
          }

          <article class="rounded-xl border border-slate-200 bg-white p-4">
            <h4 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">
              Donnees INSEE
            </h4>
            @if (host.inseeLoading()) {
              <p class="mt-3 text-sm text-slate-600">Chargement des données INSEE...</p>
            } @else if (host.inseeError()) {
              <p
                class="mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700"
              >
                {{ host.inseeError() }}
              </p>
            } @else if (host.inseeModule(); as inseeData) {
              <div class="mt-3 grid gap-3 md:grid-cols-2 xl:grid-cols-4">
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Densité</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.populationDensityPerKm2 !== null) {
                      {{ inseeData.populationDensityPerKm2 | number: '1.0-0' }} hab./km²
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Code INSEE: {{ inseeData.inseeCode || 'N/A' }} · CP:
                    {{ inseeData.postalCode || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Evolution demographique
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.populationGrowthPct !== null) {
                      {{ inseeData.populationGrowthPct | number: '1.0-1' }} %
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    @if (
                      inseeData.populationStartYear !== null && inseeData.populationEndYear !== null
                    ) {
                      {{ inseeData.populationStartYear }} - {{ inseeData.populationEndYear }}
                    } @else {
                      Periode indisponible
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Croissance population
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.populationGrowthAbs !== null) {
                      {{ inseeData.populationGrowthAbs | number: '1.0-0' }} hab.
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Pop. actuelle:
                    @if (inseeData.populationCurrent !== null) {
                      {{ inseeData.populationCurrent | number: '1.0-0' }}
                    } @else {
                      N/A
                    }
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Revenu median</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.medianIncome !== null) {
                      {{ inseeData.medianIncome | number: '1.0-0' }} €
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Annee: {{ inseeData.medianIncomeYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">
                    Taux de propriétaires
                  </p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.ownersRatePct !== null) {
                      {{ inseeData.ownersRatePct | number: '1.0-1' }} %
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    {{ inseeData.ownersRateScope || 'Zone indisponible' }} ·
                    {{ inseeData.ownersRateYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Taux de chomage</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.unemploymentRatePct !== null) {
                      {{ inseeData.unemploymentRatePct | number: '1.0-1' }} %
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Annee: {{ inseeData.unemploymentYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Age moyen</p>
                  <p class="mt-1 text-base font-semibold text-slate-900">
                    @if (inseeData.averageAge !== null) {
                      {{ inseeData.averageAge | number: '1.0-1' }} ans
                    } @else {
                      N/A
                    }
                  </p>
                  <p class="text-xs text-slate-600">
                    Annee: {{ inseeData.averageAgeYear || 'N/A' }}
                  </p>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <p class="text-xs uppercase tracking-[0.12em] text-slate-500">Autres criteres</p>
                  <p class="text-sm text-slate-700">
                    Densite:
                    <strong>
                      @if (inseeData.populationDensityPerKm2 !== null) {
                        {{ inseeData.populationDensityPerKm2 | number: '1.0-0' }} hab./km²
                      } @else {
                        N/A
                      }
                    </strong>
                  </p>
                  <p class="text-sm text-slate-700">
                    Pauvrete:
                    <strong>
                      @if (inseeData.povertyRatePct !== null) {
                        {{ inseeData.povertyRatePct | number: '1.0-1' }} %
                      } @else {
                        N/A
                      }
                    </strong>
                  </p>
                  <p class="text-sm text-slate-700">
                    Gini:
                    <strong>
                      @if (inseeData.giniIndex !== null) {
                        {{ inseeData.giniIndex | number: '1.0-3' }}
                      } @else {
                        N/A
                      }
                    </strong>
                  </p>
                </div>
              </div>
              <p class="mt-3 text-xs text-slate-500">
                Sources: geo.api.gouv.fr, OpenDataSoft (INSEE).
              </p>
            } @else {
              <p class="mt-3 text-sm text-slate-600">Aucune donnée INSEE disponible.</p>
            }
          </article>
        </section>
