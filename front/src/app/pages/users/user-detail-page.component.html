@if (loading()) {
  <section class="panel p-5 text-sm text-slate-700" role="status" aria-live="polite">
    Chargement de l'utilisateur...
  </section>
} @else if (error()) {
  <section class="panel border border-red-200 bg-red-50 p-5 text-sm text-red-700" role="alert">
    {{ error() }}
  </section>
} @else {
  @if (user(); as user) {
    <section class="space-y-4" aria-labelledby="user-detail-title">
      <header class="panel p-5">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-600">Fiche utilisateur</p>
            <h2 id="user-detail-title" class="mt-2 text-3xl font-semibold tracking-tight text-slate-900">
              {{ displayUserName(user) }}
            </h2>
            <p class="mt-1 text-sm text-slate-500">{{ displayValue(user.email) }}</p>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <a
              routerLink="/app/utilisateurs"
              class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
            >
              Retour utilisateurs
            </a>
            <span class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white">
              {{ accountTypeLabel(user.accountType) }}
            </span>
            @if (!editing()) {
              <button
                type="button"
                class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                (click)="startEditing()"
              >
                Modifier
              </button>
            } @else {
              <button
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                [disabled]="savePending()"
                (click)="cancelEditing()"
              >
                Annuler
              </button>
              <button
                type="button"
                class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700"
                [disabled]="savePending()"
                (click)="saveUser()"
              >
                {{ savePending() ? "Enregistrement..." : "Enregistrer" }}
              </button>
            }
          </div>
        </div>

        @if (feedback()) {
          <p class="mt-4 rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700" role="status" aria-live="polite">
            {{ feedback() }}
          </p>
        }
      </header>

      <section class="panel p-5">
        <h3 class="text-xl font-semibold text-slate-900">Informations utilisateur</h3>

        <form class="mt-4 grid gap-3 sm:grid-cols-2" [formGroup]="form" novalidate>
          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Prenom</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="firstName" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ user.firstName }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Nom</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="lastName" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ user.lastName }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Email</p>
            @if (editing()) {
              <input class="field-input mt-2" type="email" formControlName="email" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.email) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Telephone</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="phone" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.phone) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3 sm:col-span-2">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Adresse</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="address" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.address) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Code postal</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="postalCode" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.postalCode) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Ville</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="city" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.city) }}</p>
            }
          </article>
        </form>
      </section>

      <section class="panel p-5">
        <h3 class="text-xl font-semibold text-slate-900">Biens lies</h3>
        @if (linkedProperties().length === 0) {
          <p class="mt-3 text-sm text-slate-600">Aucun bien lie a cet utilisateur.</p>
        } @else {
          <div class="mt-4 space-y-3">
            @for (propertyLink of linkedProperties(); track propertyLink.propertyId) {
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <div class="flex flex-wrap items-start justify-between gap-2">
                  <a
                    [routerLink]="['/app/bien', propertyLink.propertyId]"
                    class="text-lg font-semibold text-slate-900 transition hover:text-blue-700"
                  >
                    {{ propertyLink.title }}
                  </a>
                  <span class="rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">
                    {{ relationLabel(propertyLink.relationRole) }}
                  </span>
                </div>
                <p class="mt-1 text-sm text-slate-600">
                  {{ propertyLink.postalCode }} {{ propertyLink.city }} Â· {{ propertyLink.status }}
                </p>
              </article>
            }
          </div>
        }
      </section>
    </section>
  }
}
