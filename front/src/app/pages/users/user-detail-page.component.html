@if (loading()) {
  <section class="panel p-5 text-sm text-slate-700" role="status" aria-live="polite">
    Chargement de l'utilisateur...
  </section>
} @else if (error()) {
  <section class="panel border border-red-200 bg-red-50 p-5 text-sm text-red-700" role="alert">
    {{ error() }}
  </section>
} @else {
  @if (user(); as user) {
    <section class="space-y-4" aria-labelledby="user-detail-title">
      <header class="panel p-5">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-600">
              Fiche utilisateur
            </p>
            <h2
              id="user-detail-title"
              class="mt-2 text-3xl font-semibold tracking-tight text-slate-900"
            >
              {{ displayUserName(user) }}
            </h2>
            <p class="mt-1 text-sm text-slate-500">{{ displayValue(user.email) }}</p>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <a
              routerLink="/app/utilisateurs"
              class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
            >
              Retour utilisateurs
            </a>
            <span class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white">
              {{ accountTypeLabel(user.accountType) }}
            </span>
          </div>
        </div>

        @if (feedback()) {
          <p
            class="mt-4 rounded-xl bg-slate-100 px-3 py-2 text-sm text-slate-700"
            role="status"
            aria-live="polite"
          >
            {{ feedback() }}
          </p>
        }
      </header>

      <section class="panel p-5">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <h3 class="text-xl font-semibold text-slate-900">Informations utilisateur</h3>
          <div class="flex flex-wrap items-center gap-2">
            @if (!editing()) {
              <button
                type="button"
                class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
                (click)="startEditing()"
              >
                Modifier
              </button>
            } @else {
              <button
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
                [disabled]="savePending()"
                (click)="cancelEditing()"
              >
                Annuler
              </button>
              <button
                type="button"
                class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700"
                [disabled]="savePending()"
                (click)="saveUser()"
              >
                {{ savePending() ? 'Enregistrement...' : 'Enregistrer' }}
              </button>
            }
          </div>
        </div>

        <form class="mt-4 grid gap-3 sm:grid-cols-2" [formGroup]="form" novalidate>
          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Prénom</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="firstName" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ user.firstName }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Nom</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="lastName" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ user.lastName }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Email</p>
            @if (editing()) {
              <input class="field-input mt-2" type="email" formControlName="email" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.email) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">
              Téléphone
            </p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="phone" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.phone) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3 sm:col-span-2">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Adresse</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="address" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.address) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">
              Code postal
            </p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="postalCode" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.postalCode) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">Ville</p>
            @if (editing()) {
              <input class="field-input mt-2" type="text" formControlName="city" />
            } @else {
              <p class="mt-2 text-sm text-slate-900">{{ displayValue(user.city) }}</p>
            }
          </article>

          <article class="rounded-xl border border-slate-200 bg-slate-50 p-3 sm:col-span-2">
            <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500">
              Notes personnelles
            </p>
            @if (editing()) {
              <textarea
                class="field-input mt-2"
                rows="5"
                formControlName="personalNotes"
                placeholder="Notes internes sur ce contact..."
              ></textarea>
            } @else {
              <p class="mt-2 whitespace-pre-line text-sm text-slate-900">
                {{ displayValue(user.personalNotes) }}
              </p>
            }
          </article>
        </form>
      </section>

      <section class="panel p-5">
        <h3 class="text-xl font-semibold text-slate-900">Visites</h3>

        @if (visitsLoading()) {
          <p class="mt-3 text-sm text-slate-600">Chargement des visites...</p>
        } @else if (visitsError()) {
          <p class="mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
            {{ visitsError() }}
          </p>
        } @else if (visitedObjects().length === 0) {
          <p class="mt-3 text-sm text-slate-600">Aucune visite pour ce contact.</p>
        } @else {
          <div class="mt-4 space-y-3">
            @for (visitedObject of visitedObjects(); track visitedObject.propertyId) {
              <article class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <div class="flex flex-wrap items-start justify-between gap-2">
                  <a
                    [routerLink]="['/app/bien', visitedObject.propertyId]"
                    class="text-lg font-semibold text-slate-900 transition hover:text-blue-700"
                  >
                    {{ visitedObject.propertyTitle }}
                  </a>
                  <a
                    [routerLink]="['/app/visites', visitedObject.latestVisitId]"
                    class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 transition hover:bg-slate-100"
                  >
                    Ouvrir la dernière visite
                  </a>
                </div>
                <p class="mt-1 text-sm text-slate-600">
                  Dernière visite: {{ visitedObject.latestStartsAt | date: 'short' }} -
                  {{ visitedObject.latestEndsAt | date: 'shortTime' }}
                </p>
                <p class="mt-1 text-xs text-slate-500">{{ visitedObject.visitsCount }} visite(s)</p>
              </article>
            }
          </div>
        }
      </section>

      <section class="panel p-5">
        <h3 class="text-xl font-semibold text-slate-900">Biens</h3>
        @if (linkedProperties().length === 0) {
          <p class="mt-3 text-sm text-slate-600">Aucun bien lié à cet utilisateur.</p>
        } @else {
          <section class="mt-4 overflow-x-auto rounded-xl border border-slate-200">
            <table class="min-w-full border-collapse text-sm">
              <thead
                class="bg-slate-100 text-left text-xs font-semibold uppercase tracking-[0.12em] text-slate-600"
              >
                <tr>
                  <th class="px-4 py-3">Bien</th>
                  <th class="px-4 py-3">Ville</th>
                  <th class="px-4 py-3">Statut</th>
                  <th class="px-4 py-3">Relation</th>
                  <th class="px-4 py-3">Action</th>
                </tr>
              </thead>
              <tbody>
                @for (
                  propertyLink of linkedProperties();
                  track propertyLink.propertyId + '-' + propertyLink.relationRole
                ) {
                  <tr class="border-t border-slate-200 align-top">
                    <td class="px-4 py-3">
                      <p class="font-semibold text-slate-900">{{ propertyLink.title }}</p>
                    </td>
                    <td class="px-4 py-3 text-slate-700">
                      {{ propertyLink.postalCode }} {{ propertyLink.city }}
                    </td>
                    <td class="px-4 py-3 text-slate-700">{{ statusLabel(propertyLink.status) }}</td>
                    <td class="px-4 py-3">
                      <span
                        class="rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700"
                      >
                        {{ relationLabel(propertyLink.relationRole) }}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <a
                        [routerLink]="['/app/bien', propertyLink.propertyId]"
                        class="text-slate-800 transition hover:text-blue-700"
                      >
                        Voir bien
                      </a>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </section>
        }
      </section>
    </section>
  }
}
