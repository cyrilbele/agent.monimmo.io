<section class="space-y-4" aria-labelledby="visit-detail-title">
  <header class="panel p-5">
    <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-600">Visites</p>
    <h2 id="visit-detail-title" class="mt-2 text-3xl font-semibold tracking-tight text-slate-900">
      Fiche visite
    </h2>
  </header>

  @if (loading()) {
    <section class="panel p-5 text-sm text-slate-700" role="status" aria-live="polite">
      Chargement de la visite...
    </section>
  } @else if (error()) {
    <section class="panel border border-red-200 bg-red-50 p-5 text-sm text-red-700" role="alert">
      {{ error() }}
    </section>
  } @else if (visit(); as visit) {
    <article class="panel space-y-5 p-5">
      <div class="grid gap-4 md:grid-cols-2">
        <section class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <h3 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">Rendez-vous</h3>
          <p class="mt-3 text-base font-semibold text-slate-900">
            {{ visit.startsAt | date: "EEEE d MMMM y, HH:mm":"":"fr" }}
          </p>
          <p class="mt-1 text-sm text-slate-600">
            Fin: {{ visit.endsAt | date: "HH:mm":"":"fr" }}
          </p>
        </section>

        <section class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <h3 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">Bien</h3>
          <a
            [routerLink]="['/app/bien', visit.propertyId]"
            class="mt-3 inline-flex text-base font-semibold text-slate-900 transition hover:text-blue-700"
          >
            {{ visit.propertyTitle }}
          </a>
        </section>
      </div>

      <section class="rounded-xl border border-slate-200 bg-slate-50 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">Prospect</h3>
        <a
          [routerLink]="['/app/utilisateurs', visit.prospectUserId]"
          class="mt-3 inline-flex text-base font-semibold text-slate-900 transition hover:text-blue-700"
        >
          {{ visit.prospectFirstName }} {{ visit.prospectLastName }}
        </a>
        <p class="mt-1 text-sm text-slate-600">
          {{ visit.prospectEmail || visit.prospectPhone || "Contact non renseigné" }}
        </p>
      </section>

      <section class="rounded-xl border border-slate-200 bg-slate-50 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">Bon de visite</h3>

        @if (visit.bonDeVisiteFileName) {
          <p class="mt-3 text-sm text-slate-700">
            Fichier actuel: <span class="font-semibold text-slate-900">{{ visit.bonDeVisiteFileName }}</span>
          </p>
        } @else {
          <p class="mt-3 text-sm text-slate-500">Aucun bon de visite chargé.</p>
        }

        <div class="mt-3 flex flex-wrap items-center gap-2">
          <input
            type="file"
            class="field-input max-w-sm"
            accept=".pdf,image/*"
            (change)="onFileInputChange($event)"
          />
          <button
            type="button"
            class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-70"
            [disabled]="uploadPending()"
            (click)="uploadBonDeVisite()"
          >
            {{ uploadPending() ? "Upload..." : "Charger le bon de visite" }}
          </button>
        </div>

        @if (selectedFileName()) {
          <p class="mt-2 text-xs text-slate-500">Fichier sélectionné: {{ selectedFileName() }}</p>
        }

        @if (uploadFeedback()) {
          <p class="mt-2 rounded-lg bg-slate-100 px-3 py-2 text-sm text-slate-700">
            {{ uploadFeedback() }}
          </p>
        }
      </section>

      <section class="rounded-xl border border-slate-200 bg-slate-50 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-[0.12em] text-slate-500">Compte rendu</h3>
        <form class="mt-3 space-y-3" [formGroup]="compteRenduForm" (ngSubmit)="saveCompteRendu()">
          <textarea
            rows="7"
            class="field-input"
            formControlName="compteRendu"
            placeholder="Saisir le compte rendu de visite..."
          ></textarea>
          <button
            type="submit"
            class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700 disabled:cursor-not-allowed disabled:opacity-70"
            [disabled]="savePending()"
          >
            {{ savePending() ? "Enregistrement..." : "Enregistrer le compte rendu" }}
          </button>
        </form>

        @if (saveFeedback()) {
          <p class="mt-2 rounded-lg bg-slate-100 px-3 py-2 text-sm text-slate-700">
            {{ saveFeedback() }}
          </p>
        }
      </section>
    </article>
  }
</section>
